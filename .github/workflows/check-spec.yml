name: Check Specification

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'specification/**'
      - 'schemas/**'
      - '.github/workflows/check-spec.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'specification/**'
      - 'schemas/**'
      - '.github/workflows/check-spec.yml'

jobs:
  validate-json-schema:
    name: Validate JSON Schema
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install jsonschema

      - name: Validate JSON Schema syntax
        run: |
          python -c "
          import json
          import jsonschema
          import sys
          from pathlib import Path

          errors = []
          for schema_file in Path('schemas').glob('*.json'):
              try:
                  with open(schema_file) as f:
                      schema = json.load(f)

                  # Validate it's a valid JSON Schema
                  jsonschema.Draft7Validator.check_schema(schema)
                  print(f'✅ {schema_file.name} is valid JSON Schema')
              except (json.JSONDecodeError, jsonschema.SchemaError) as e:
                  errors.append(f'❌ {schema_file.name}: {e}')
                  print(f'❌ {schema_file.name}: {e}')

          if errors:
              print(f'\n{len(errors)} schema file(s) failed validation')
              sys.exit(1)
          else:
              print(f'\n✅ All JSON Schema files are valid')
          "

  check-version-consistency:
    name: Check Version Consistency
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check version numbers match
        run: |
          python -c "
          import re
          import sys
          from pathlib import Path

          # Extract version from specification
          spec_file = Path('specification/CAYP-SPEC-v1.0.md')
          with open(spec_file) as f:
              spec_content = f.read()

          spec_version = None
          match = re.search(r'\*\*Version:\*\*\s+([\d.]+)', spec_content)
          if match:
              spec_version = match.group(1)

          # Extract version from README
          readme_file = Path('README.md')
          with open(readme_file) as f:
              readme_content = f.read()

          readme_version = None
          match = re.search(r'\*\*Version:\*\*\s+([\d.]+)', readme_content)
          if match:
              readme_version = match.group(1)

          # Extract version from CHANGELOG
          changelog_file = Path('CHANGELOG.md')
          with open(changelog_file) as f:
              changelog_content = f.read()

          # Find latest version in changelog
          changelog_version = None
          match = re.search(r'##\s+\[([\d.]+)\]', changelog_content)
          if match:
              changelog_version = match.group(1)

          print(f'Specification version: {spec_version}')
          print(f'README version: {readme_version}')
          print(f'CHANGELOG version: {changelog_version}')

          if spec_version and readme_version and spec_version == readme_version:
              print('✅ Version numbers are consistent')
          else:
              print('⚠️  Version numbers may be inconsistent (non-blocking)')
          "

  check-spec-completeness:
    name: Check Specification Completeness
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify specification sections
        run: |
          python -c "
          import re
          import sys
          from pathlib import Path

          spec_file = Path('specification/CAYP-SPEC-v1.0.md')
          with open(spec_file) as f:
              content = f.read()

          # Required sections
          required_sections = [
              'Abstract',
              'Motivation',
              'Design Principles',
              'Technical Specification',
              'Agentic Semantics',
              'Validation',
              'Security Considerations',
              'Migration from YAML',
              'Tooling Requirements',
          ]

          missing = []
          for section in required_sections:
              if section not in content:
                  missing.append(section)
                  print(f'❌ Missing section: {section}')
              else:
                  print(f'✅ Found section: {section}')

          if missing:
              print(f'\n❌ {len(missing)} required section(s) missing')
              sys.exit(1)
          else:
              print(f'\n✅ All required sections present')
          "

  check-examples-referenced:
    name: Check Examples are Referenced
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify examples are documented
        run: |
          python -c "
          import re
          from pathlib import Path

          # Get all example files
          example_files = set()
          for example in Path('examples').rglob('*.cayp'):
              example_files.add(example.name)
          for example in Path('examples').rglob('*.yaml'):
              example_files.add(example.name)

          # Check if they're mentioned in examples/README.md
          readme_file = Path('examples/README.md')
          with open(readme_file) as f:
              readme_content = f.read()

          undocumented = []
          for example in sorted(example_files):
              if example not in readme_content:
                  undocumented.append(example)
                  print(f'⚠️  {example} not mentioned in examples/README.md')
              else:
                  print(f'✅ {example} documented')

          if undocumented:
              print(f'\n⚠️  {len(undocumented)} example(s) not documented (non-blocking)')
          else:
              print(f'\n✅ All examples are documented')
          "

  check-no-todos:
    name: Check for TODO markers
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Search for TODO/FIXME in specification
        run: |
          if grep -r "TODO\|FIXME" specification/ --include="*.md" ; then
            echo "⚠️  Found TODO/FIXME markers in specification (non-blocking)"
            exit 0
          else
            echo "✅ No TODO/FIXME markers in specification"
          fi
